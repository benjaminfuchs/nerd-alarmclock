#!/usr/bin/python3
# --------------------------------------------------------------------------
# Class definition of LedControllerThread - utility functions for the LEDs
#
# Author: Benjamin Fuchs
# License: GPL3
#
# Website: https://github.com/benjaminfuchs/who_disposer
#
# --------------------------------------------------------------------------

from threading import Thread

from nclock import Led


class LedControllerThread(Thread):
    """ LedControllerThread thread """

    def __init__(self, settings):
        """ Constructor """

        super(LedControllerThread, self).__init__(name="LedControllerThread")
        self._settings = settings
        self._stop_event = settings.stop_event
        self._statusLed = Led(settings.get_value('GPIO','statusLed'))
        self._tankLed = Led(settings.get_value('GPIO','tankLed'))
        self._state = settings.get('state')
        self._tank = settings.get('tank.status')
        settings.add_settings_listener('state', self.on_state)
        settings.add_settings_listener('tank.status', self.on_tank)

    def run(self):
        """ run method of thread """

        self._settings.log.msg(
            "LedControllerThread: running LedControllerThread...")
        while not self._stop_event.wait(0.5):
            if self._state == "starting":
                statusLed.toggle()
            elif self._state == "running":
                statusLed.on()
            elif self._state == "off":
                statusLed.off()
            else:
                self._settings.log.msg(
                    "LedControllerThread: [ERROR] Unkown status (%s)" % str(self._state))

            if self._tank == "full":
                tankLed.off()
            elif self._tank == "warning":
                tankLed.toggle()
            elif self._tank == "empty":
                tankLed.on()
            else:
                self._settings.log.msg(
                    "LedControllerThread: [ERROR] Unkown tanks status (%s)" % str(self._tank))

        self._settings.log.msg("LedControllerThread: shutdown")

    def on_state(self, name, old, new):
        """ process state changes """

        self._state = new

    def on_tank(self, name, old, new):
        """ process tank status changes """

        self._tank = new
